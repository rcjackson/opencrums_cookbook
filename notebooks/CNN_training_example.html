
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Code for training Convolutional Neural Network &#8212; Open Classification of Regimes in the Southeast USA</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Layerwise Relevance Propogation" href="LayerwiseRelevancePropogation.html" />
    <link rel="prev" title="Preprocessing MERRA2 data" href="Preprocessing_MERRA2.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/ai4esp.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Open Classification of Regimes in the Southeast USA</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../README.html">
                    Open Classification of Regimes in the Southeast USA
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notebooks
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Preprocessing_MERRA2.html">
   Preprocessing MERRA2 data
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Code for training Convolutional Neural Network
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="LayerwiseRelevancePropogation.html">
   Layerwise Relevance Propogation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Make_RLP_plot.html">
   Combining it all together
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/ARM-Development/arm-cookbook-template/main?urlpath=lab/tree/notebooks/notebooks/CNN_training_example.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://jupyterhub.arm.gov/hub/user-redirect/git-pull?repo=https%3A//github.com/ARM-Development/arm-cookbook-template&urlpath=lab/tree/arm-cookbook-template/notebooks/notebooks/CNN_training_example.ipynb&branch=main"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on JupyterHub"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_jupyterhub.svg">
  </span>
<span class="headerbtn__text-container">JupyterHub</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/notebooks/CNN_training_example.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Code for training Convolutional Neural Network</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="code-for-training-convolutional-neural-network">
<h1>Code for training Convolutional Neural Network<a class="headerlink" href="#code-for-training-convolutional-neural-network" title="Permalink to this headline">#</a></h1>
<p>First, load the required libraries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">glob</span> <span class="k">as</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">MaxPooling2D</span><span class="p">,</span> <span class="n">UpSampling2D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Reshape</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">ReLU</span><span class="p">,</span> <span class="n">Conv2DTranspose</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">BatchNormalization</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.regularizers</span> <span class="kn">import</span> <span class="n">l2</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/rjackson/.conda/envs/pydda_env/lib/python3.9/site-packages/xarray/backends/cfgrib_.py:27: UserWarning: Failed to load cfgrib - most likely there is a problem accessing the ecCodes library. Try `import cfgrib` to get the full error message
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<p>Next, we load the EPA AirNow data into a Pandas dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">air_now_data</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;/lcrc/group/earthscience/rjackson/epa_air_now/*.csv&#39;</span><span class="p">)</span>
<span class="n">air_now_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">,</span> <span class="n">air_now_data</span><span class="p">))</span>
<span class="n">air_now_df</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">air_now_df</span><span class="p">[</span><span class="s1">&#39;DateObserved&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; 00:00:00&#39;</span><span class="p">)</span>
<span class="n">air_now_df</span> <span class="o">=</span> <span class="n">air_now_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span>
<span class="n">air_now_df</span> <span class="o">=</span> <span class="n">air_now_df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">air_now_df</span><span class="p">[</span><span class="s1">&#39;CategoryNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

<span class="c1"># How many timesteps ahead should we predict?</span>
<span class="n">lag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">site</span> <span class="o">=</span> <span class="s2">&quot;hou&quot;</span>

<span class="c1"># Insert the path to your cropped dataset here</span>
<span class="n">input_merra_path</span> <span class="o">=</span> <span class="s1">&#39;/lcrc/group/earthscience/rjackson/MERRA2/hou_reduced/&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>This next block of code will grab the EPA AirNow classification given a particular datetime.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_air_now_label</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">air_now_df</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">time</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">air_now_df</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">time</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">air_now_df</span><span class="p">[</span><span class="s1">&#39;CategoryNumber&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>This next block of code loads the cropped MERRA2 dataset.</p>
<p>load_data takes in a list of aerosol species as inputs. The aerosol species are the abbreviations used in the MERRA2 dataset (i.e. BC, SO4, SO2, DU, SS, OC, etc.). In addition, the <em>test_data_size</em> parameter specifies the fraction of the dataset to be set aside as a testing dataset for training.</p>
<p>The returned parameters from load_data are:</p>
<ul class="simple">
<li><p>x_dataset_train, x_dataset_test: Dictionaries containing the test and training dataset inputs</p></li>
<li><p>y_train, y_test: The training and test labels corresponding to x_dataset</p></li>
<li><p>shape: The shape of the input x data.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">test_data_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">):</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">input_merra_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">CMASS*.nc&#39;</span> <span class="o">%</span> <span class="n">species</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">CMASS&quot;</span> <span class="o">%</span> <span class="n">species</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">old_shape</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">old_shape</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">inputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="s2">&quot;SO4&quot;</span> <span class="ow">or</span> <span class="n">species</span> <span class="o">==</span> <span class="s2">&quot;DMS&quot;</span> <span class="ow">or</span> <span class="n">species</span> <span class="o">==</span> <span class="s2">&quot;SO2&quot;</span><span class="p">:</span>
       <span class="n">inp</span> <span class="o">=</span> <span class="s2">&quot;SU&quot;</span>
    <span class="k">else</span><span class="p">:</span>
       <span class="n">inp</span> <span class="o">=</span> <span class="n">species</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">input_merra_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">FLUXU*.nc&#39;</span> <span class="o">%</span> <span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">FLUXU&quot;</span> <span class="o">%</span> <span class="n">inp</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">old_shape</span><span class="p">)</span>
    <span class="n">inputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">input_merra_path</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">FLUXV*.nc&#39;</span> <span class="o">%</span> <span class="n">inp</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">FLUXV&quot;</span> <span class="o">%</span> <span class="n">inp</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="p">(</span><span class="n">old_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">old_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">old_shape</span><span class="p">)</span>
    <span class="n">inputs</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span>
    <span class="n">classification</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">get_air_now_label</span><span class="p">,</span> <span class="n">times</span><span class="p">)))</span>
    <span class="n">where_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">classification</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="n">where_valid</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">classification</span> <span class="o">=</span> <span class="n">classification</span><span class="p">[</span><span class="n">where_valid</span><span class="p">]</span>
    <span class="c1"># Use classification from x days ahead</span>
    <span class="k">if</span> <span class="n">lag</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">classification</span> <span class="o">=</span> <span class="n">classification</span><span class="p">[</span><span class="n">lag</span><span class="o">*</span><span class="mi">8</span><span class="p">:]</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[:</span><span class="n">lag</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:</span> <span class="p">:]</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">classification</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
            <span class="n">inputs</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">test_data_size</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x_dataset_train</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="s1">&#39;input_2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;input_3&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">])}</span>
    <span class="n">x_dataset_test</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_1&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="s1">&#39;input_2&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]),</span>
            <span class="s1">&#39;input_3&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x_test</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">])}</span>

    <span class="k">return</span> <span class="n">x_dataset_train</span><span class="p">,</span> <span class="n">x_dataset_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">shape</span>
</pre></div>
</div>
</div>
</div>
<p>Construct the parallel CNN model. This procedure takes in 3 parameters:</p>
<ul class="simple">
<li><p>shape: the shape of the input data as a tuple</p></li>
<li><p>the_dict: A dictionary containing the model hyperparameters</p></li>
<li><p>dataset: The input dataset returned by <em>load_data</em></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">classifier_model</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">the_dict</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">mpool_1s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">in_layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dict_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dict_keys</span><span class="p">)):</span>
        <span class="n">inp_layer</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="n">dict_keys</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">mpool_1</span> <span class="o">=</span> <span class="n">inp_layer</span>
        <span class="n">in_layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inp_layer</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">the_dict</span><span class="p">[</span><span class="s1">&#39;num_layers&#39;</span><span class="p">]):</span>
            <span class="n">conv2d_1</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">the_dict</span><span class="p">[</span><span class="s1">&#39;num_channels&#39;</span><span class="p">],</span>
                <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="n">the_dict</span><span class="p">[</span><span class="s1">&#39;activation&#39;</span><span class="p">],</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span>
                <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">)(</span><span class="n">mpool_1</span><span class="p">)</span>
            <span class="n">conv2d_1</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">conv2d_1</span><span class="p">)</span>
            <span class="n">mpool_1</span> <span class="o">=</span> <span class="n">MaxPooling2D</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))(</span><span class="n">conv2d_1</span><span class="p">)</span>
        <span class="n">mpool_1s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">mpool_1</span><span class="p">))</span>
    <span class="n">flat_1</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()(</span><span class="n">mpool_1s</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">the_dict</span><span class="p">[</span><span class="s1">&#39;num_dense_layers&#39;</span><span class="p">]):</span>
        <span class="n">flat_1</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="n">the_dict</span><span class="p">[</span><span class="s1">&#39;num_dense_nodes&#39;</span><span class="p">],</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span>
                <span class="p">)(</span><span class="n">flat_1</span><span class="p">)</span>
        <span class="n">flat_1</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">()(</span><span class="n">flat_1</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;class&quot;</span><span class="p">)(</span><span class="n">flat_1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="n">in_layers</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Do the model training and data loading.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="n">x_ds_train</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">x_ds_test</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">y_train</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_test</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Adjust to the species you want to have</span>
    <span class="n">species_list</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;species_list&#39;</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="n">x_ds_train1</span><span class="p">,</span> <span class="n">x_ds_test1</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
        <span class="n">x_ds_train</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_ds_train1</span><span class="p">)</span>
        <span class="n">x_ds_test</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">x_ds_test1</span><span class="p">)</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">classifier_model</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">x_ds_test</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">]),</span>
        <span class="n">loss</span><span class="o">=</span><span class="s2">&quot;categorical_crossentropy&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;acc&#39;</span><span class="p">])</span>
    <span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="c1"># AQI classes inbalanced, need weights</span>
    <span class="n">class_weight</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mi">510</span><span class="p">}</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
            <span class="n">x_ds_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> 
            <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">x_ds_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;num_epochs&quot;</span><span class="p">],</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">],</span> <span class="n">class_weight</span><span class="o">=</span><span class="n">class_weight</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;classifier-</span><span class="si">%s</span><span class="s1">-lag-</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">lag</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span>
</pre></div>
</div>
</div>
</div>
<p>Call the model training code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">default_config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;num_epochs&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>        <span class="c1"># Number of training epochs. Recommended to use 200+ fo, 10 here is to make cookbook short</span>
        <span class="s2">&quot;num_channels&quot;</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>     <span class="c1"># Number of channels in Conv2D layer </span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="c1"># Learning rate for training</span>
        <span class="s2">&quot;num_dense_nodes&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>    <span class="c1"># Number of nodes in each dense layer of the classifier</span>
        <span class="s2">&quot;num_dense_layers&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>   <span class="c1"># Number of layers in classifier portion</span>
        <span class="s2">&quot;activation&quot;</span><span class="p">:</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>    <span class="c1"># Activation function used (ReLU is typically good)</span>
        <span class="s2">&quot;batch_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>        <span class="c1"># Batch size for training</span>
        <span class="s2">&quot;num_layers&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>         <span class="c1"># Number of Conv2D layers in feature extractor</span>
        <span class="c1"># Aerosol species to use in model training</span>
        <span class="s2">&quot;species_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;SS&#39;</span><span class="p">,</span> <span class="s1">&#39;SO4&#39;</span><span class="p">,</span> <span class="s1">&#39;SO2&#39;</span><span class="p">,</span> <span class="s1">&#39;OC&#39;</span><span class="p">,</span> <span class="s1">&#39;DU&#39;</span><span class="p">,</span> <span class="s1">&#39;DMS&#39;</span><span class="p">,</span> <span class="s1">&#39;BC&#39;</span><span class="p">]}</span>

<span class="n">history</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">default_config</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SS
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/rjackson/.conda/envs/pydda_env/lib/python3.9/site-packages/xarray/backends/plugins.py:61: RuntimeWarning: Engine &#39;cfgrib&#39; loading failed:
Cannot find the ecCodes library
  warnings.warn(f&quot;Engine {name!r} loading failed:\n{ex}&quot;, RuntimeWarning)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;xarray.Dataset&gt;
Dimensions:    (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon        (lon) float64 -105.0 -104.4 -103.8 ... -86.88 -86.25 -85.62
  * lat        (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 33.0 33.5 34.0 34.5
  * time       (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    SSCMASS    (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
    SSCMASS25  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-10-21 13:52:27.969958: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-10-21 13:52:28.469454: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1525] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 38396 MB memory:  -&gt; device: 0, name: NVIDIA A100-SXM4-40GB, pci bus id: 0000:07:00.0, compute capability: 8.0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SO4
&lt;xarray.Dataset&gt;
Dimensions:   (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon       (lon) float64 -105.0 -104.4 -103.8 -103.1 ... -86.88 -86.25 -85.62
  * lat       (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 33.0 33.5 34.0 34.5
  * time      (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    SO4CMASS  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
SO2
&lt;xarray.Dataset&gt;
Dimensions:   (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon       (lon) float64 -105.0 -104.4 -103.8 -103.1 ... -86.88 -86.25 -85.62
  * lat       (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 33.0 33.5 34.0 34.5
  * time      (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    SO2CMASS  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
OC
&lt;xarray.Dataset&gt;
Dimensions:  (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon      (lon) float64 -105.0 -104.4 -103.8 -103.1 ... -86.88 -86.25 -85.62
  * lat      (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 32.5 33.0 33.5 34.0 34.5
  * time     (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    OCCMASS  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
DU
&lt;xarray.Dataset&gt;
Dimensions:    (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon        (lon) float64 -105.0 -104.4 -103.8 ... -86.88 -86.25 -85.62
  * lat        (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 33.0 33.5 34.0 34.5
  * time       (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    DUCMASS    (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
    DUCMASS25  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
DMS
&lt;xarray.Dataset&gt;
Dimensions:   (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon       (lon) float64 -105.0 -104.4 -103.8 -103.1 ... -86.88 -86.25 -85.62
  * lat       (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 33.0 33.5 34.0 34.5
  * time      (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    DMSCMASS  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
BC
&lt;xarray.Dataset&gt;
Dimensions:  (lon: 32, lat: 20, time: 90744)
Coordinates:
  * lon      (lon) float64 -105.0 -104.4 -103.8 -103.1 ... -86.88 -86.25 -85.62
  * lat      (lat) float64 25.0 25.5 26.0 26.5 27.0 ... 32.5 33.0 33.5 34.0 34.5
  * time     (time) datetime64[ns] 2010-01-01T00:30:00 ... 2020-05-08T23:30:00
Data variables:
    BCCMASS  (time, lat, lon) float32 dask.array&lt;chunksize=(8760, 20, 32), meta=np.ndarray&gt;
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/rjackson/.conda/envs/pydda_env/lib/python3.9/site-packages/keras/optimizer_v2/adam.py:105: UserWarning: The `lr` argument is deprecated, use `learning_rate` instead.
  super(Adam, self).__init__(name, **kwargs)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Model: &quot;model&quot;
__________________________________________________________________________________________________
 Layer (type)                   Output Shape         Param #     Connected to                     
==================================================================================================
 input_1 (InputLayer)           [(None, 20, 32, 1)]  0           []                               
                                                                                                  
 input_2 (InputLayer)           [(None, 20, 32, 1)]  0           []                               
                                                                                                  
 input_3 (InputLayer)           [(None, 20, 32, 1)]  0           []                               
                                                                                                  
 conv2d (Conv2D)                (None, 20, 32, 128)  640         [&#39;input_1[0][0]&#39;]                
                                                                                                  
 conv2d_2 (Conv2D)              (None, 20, 32, 128)  640         [&#39;input_2[0][0]&#39;]                
                                                                                                  
 conv2d_4 (Conv2D)              (None, 20, 32, 128)  640         [&#39;input_3[0][0]&#39;]                
                                                                                                  
 batch_normalization (BatchNorm  (None, 20, 32, 128)  512        [&#39;conv2d[0][0]&#39;]                 
 alization)                                                                                       
                                                                                                  
 batch_normalization_2 (BatchNo  (None, 20, 32, 128)  512        [&#39;conv2d_2[0][0]&#39;]               
 rmalization)                                                                                     
                                                                                                  
 batch_normalization_4 (BatchNo  (None, 20, 32, 128)  512        [&#39;conv2d_4[0][0]&#39;]               
 rmalization)                                                                                     
                                                                                                  
 max_pooling2d (MaxPooling2D)   (None, 10, 16, 128)  0           [&#39;batch_normalization[0][0]&#39;]    
                                                                                                  
 max_pooling2d_2 (MaxPooling2D)  (None, 10, 16, 128)  0          [&#39;batch_normalization_2[0][0]&#39;]  
                                                                                                  
 max_pooling2d_4 (MaxPooling2D)  (None, 10, 16, 128)  0          [&#39;batch_normalization_4[0][0]&#39;]  
                                                                                                  
 conv2d_1 (Conv2D)              (None, 10, 16, 128)  65664       [&#39;max_pooling2d[0][0]&#39;]          
                                                                                                  
 conv2d_3 (Conv2D)              (None, 10, 16, 128)  65664       [&#39;max_pooling2d_2[0][0]&#39;]        
                                                                                                  
 conv2d_5 (Conv2D)              (None, 10, 16, 128)  65664       [&#39;max_pooling2d_4[0][0]&#39;]        
                                                                                                  
 batch_normalization_1 (BatchNo  (None, 10, 16, 128)  512        [&#39;conv2d_1[0][0]&#39;]               
 rmalization)                                                                                     
                                                                                                  
 batch_normalization_3 (BatchNo  (None, 10, 16, 128)  512        [&#39;conv2d_3[0][0]&#39;]               
 rmalization)                                                                                     
                                                                                                  
 batch_normalization_5 (BatchNo  (None, 10, 16, 128)  512        [&#39;conv2d_5[0][0]&#39;]               
 rmalization)                                                                                     
                                                                                                  
 max_pooling2d_1 (MaxPooling2D)  (None, 5, 8, 128)   0           [&#39;batch_normalization_1[0][0]&#39;]  
                                                                                                  
 max_pooling2d_3 (MaxPooling2D)  (None, 5, 8, 128)   0           [&#39;batch_normalization_3[0][0]&#39;]  
                                                                                                  
 max_pooling2d_5 (MaxPooling2D)  (None, 5, 8, 128)   0           [&#39;batch_normalization_5[0][0]&#39;]  
                                                                                                  
 flatten (Flatten)              (None, 5120)         0           [&#39;max_pooling2d_1[0][0]&#39;]        
                                                                                                  
 flatten_1 (Flatten)            (None, 5120)         0           [&#39;max_pooling2d_3[0][0]&#39;]        
                                                                                                  
 flatten_2 (Flatten)            (None, 5120)         0           [&#39;max_pooling2d_5[0][0]&#39;]        
                                                                                                  
 add (Add)                      (None, 5120)         0           [&#39;flatten[0][0]&#39;,                
                                                                  &#39;flatten_1[0][0]&#39;,              
                                                                  &#39;flatten_2[0][0]&#39;]              
                                                                                                  
 dense (Dense)                  (None, 8)            40968       [&#39;add[0][0]&#39;]                    
                                                                                                  
 batch_normalization_6 (BatchNo  (None, 8)           32          [&#39;dense[0][0]&#39;]                  
 rmalization)                                                                                     
                                                                                                  
 dense_1 (Dense)                (None, 8)            72          [&#39;batch_normalization_6[0][0]&#39;]  
                                                                                                  
 batch_normalization_7 (BatchNo  (None, 8)           32          [&#39;dense_1[0][0]&#39;]                
 rmalization)                                                                                     
                                                                                                  
 dense_2 (Dense)                (None, 8)            72          [&#39;batch_normalization_7[0][0]&#39;]  
                                                                                                  
 batch_normalization_8 (BatchNo  (None, 8)           32          [&#39;dense_2[0][0]&#39;]                
 rmalization)                                                                                     
                                                                                                  
 class (Dense)                  (None, 5)            45          [&#39;batch_normalization_8[0][0]&#39;]  
                                                                                                  
==================================================================================================
Total params: 243,237
Trainable params: 241,653
Non-trainable params: 1,584
__________________________________________________________________________________________________
Epoch 1/10
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2022-10-21 13:56:35.550070: I tensorflow/stream_executor/cuda/cuda_dnn.cc:366] Loaded cuDNN version 8201
2022-10-21 13:56:39.240906: I tensorflow/core/platform/default/subprocess.cc:304] Start cannot spawn child process: No such file or directory
2022-10-21 13:56:43.187227: I tensorflow/stream_executor/cuda/cuda_blas.cc:1774] TensorFloat-32 will be used for the matrix multiplication. This will only be logged once.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5171/5171 [==============================] - 37s 5ms/step - loss: 17.7415 - acc: 0.1739 - val_loss: 1.6914 - val_acc: 0.2393
Epoch 2/10
5171/5171 [==============================] - 23s 5ms/step - loss: 13.6297 - acc: 0.2408 - val_loss: 1.7013 - val_acc: 0.2383
Epoch 3/10
5171/5171 [==============================] - 23s 4ms/step - loss: 11.5479 - acc: 0.2662 - val_loss: 1.5164 - val_acc: 0.2916
Epoch 4/10
5171/5171 [==============================] - 23s 5ms/step - loss: 10.2620 - acc: 0.2709 - val_loss: 1.5523 - val_acc: 0.2610
Epoch 5/10
5171/5171 [==============================] - 23s 5ms/step - loss: 9.2578 - acc: 0.2775 - val_loss: 1.5187 - val_acc: 0.2725
Epoch 6/10
5171/5171 [==============================] - 23s 4ms/step - loss: 8.3513 - acc: 0.2832 - val_loss: 1.6070 - val_acc: 0.2544
Epoch 7/10
5171/5171 [==============================] - 23s 4ms/step - loss: 7.5896 - acc: 0.2909 - val_loss: 1.4485 - val_acc: 0.2831
Epoch 8/10
5171/5171 [==============================] - 23s 4ms/step - loss: 7.3933 - acc: 0.2979 - val_loss: 1.4658 - val_acc: 0.2802
Epoch 9/10
5171/5171 [==============================] - 23s 5ms/step - loss: 6.8175 - acc: 0.2969 - val_loss: 1.3488 - val_acc: 0.2961
Epoch 10/10
3696/5171 [====================&gt;.........] - ETA: 5s - loss: 6.5437 - acc: 0.3028
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Preprocessing_MERRA2.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Preprocessing MERRA2 data</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="LayerwiseRelevancePropogation.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Layerwise Relevance Propogation</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Geospatial Computing, Innovation, and Sensing @ ANL<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>